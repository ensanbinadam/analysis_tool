<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„ - V17 (Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #27ae60;
            --accent-color: #2980b9;
            --bg-color: #f4f6f8;
            --border-color: #ddd;
            --custom-title-bg: #fff8e1; /* Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠ */
            --custom-title-text: #795548;
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: #333;
            direction: rtl;
        }

        /* --- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… --- */
        .control-panel {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-width: 1000px;
            margin: 0 auto 30px auto;
            border: 1px solid #3498db;
        }
        .control-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px dashed #eee;
            padding-bottom: 10px;
        }
        .control-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        .control-group {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .control-group h3 { margin-top: 0; font-size: 13px; color: var(--accent-color); margin-bottom: 10px; }
        .input-field {
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: 'Cairo';
            font-size: 12px;
            box-sizing: border-box;
        }
        .input-field:focus { border-color: var(--accent-color); outline: none; }
        
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
        .main-actions {
            text-align: center;
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            margin: 0 5px;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn-upload { background-color: #3498db; }
        .btn-print { background-color: #2c3e50; }
        .btn-excel { background-color: #27ae60; }
        .btn-img { background-color: #8e44ad; }

        .hint-text {
            font-size: 11px;
            color: #7f8c8d;
            margin-top: 8px;
            background-color: #f0f3f4;
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
        }

        /* --- Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ± --- */
        .page-container {
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            background: #fff;
            padding: 10mm;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* 1. Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© */
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        .header-col { flex: 1; }
        .header-right { text-align: center; }
        .header-center { text-align: center; }
        .header-left { text-align: center; } 

        .header-text { font-size: 12px; font-weight: 600; margin-bottom: 3px; }
        .report-title { 
            font-weight: bold; 
            font-size: 18px; 
            color: var(--primary-color); 
            text-decoration: underline;
            margin-top: 10px;
            display: block;
        }

        /* 2. Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª */
        .info-bar {
            background-color: #e8f6f3;
            color: #145a32;
            border: 1px solid #d1f2eb;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            font-weight: bold;
            font-size: 13px;
        }

        /* 3. Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØ±Ø¹ÙŠ (Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠ) */
        .custom-title-bar {
            background-color: var(--custom-title-bg);
            color: var(--custom-title-text);
            border: 1px solid #ffe0b2;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
            display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
        }

        /* 4. Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        .table-section { margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th, td { border: 1px solid #bbb; padding: 5px; text-align: center; }
        .main-header th { background-color: var(--primary-color); color: #fff; }
        .sub-header th { background-color: #f2f3f4; color: #333; font-size: 10px; }
        .col-separator { border-left: 2px solid #555 !important; }
        tr:nth-child(even) { background-color: #fafafa; }

        /* 5. Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ */
        .chart-section {
            flex-grow: 1;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 300px;
            display: flex;
            justify-content: center;
        }

        /* 6. Ø§Ù„ØªØ°ÙŠÙŠÙ„ (Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©) */
        .report-footer {
            margin-top: auto; 
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .teacher-signature {
            text-align: left;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 14px;
            padding-left: 40px;
        }
        .footer-credits {
            text-align: center;
            font-size: 10px;
            color: #7f8c8d;
            margin-top: 10px;
        }
        .footer-credits a { color: #2980b9; text-decoration: none; margin: 0 5px; }

        /* ================= Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ================= */
        @media print {
            @page { size: A4; margin: 0; }
            body { background: none; padding: 0; margin: 0; }
            .control-panel { display: none !important; }
            .footer-credits { display: none !important; }

            .page-container { 
                width: 210mm;
                padding: 5mm 10mm; 
                margin: 0 auto;
                border: none;
                box-shadow: none;
                height: 297mm;
                display: block;
            }

            .header-section { margin-bottom: 10px; padding-bottom: 5px; }
            .info-bar { margin-bottom: 10px; padding: 5px; }
            .custom-title-bar { margin-bottom: 15px; padding: 5px; border: 1px solid #ddd; background-color: #fff8e1 !important; -webkit-print-color-adjust: exact; }
            .table-section { margin-bottom: 20px; }
            table { font-size: 10px; }
            th, td { padding: 4px; }

            .chart-section { 
                padding: 0; 
                border: none; 
                margin-bottom: 60px;
            }
            .chart-container { height: 260px !important; }

            .report-footer {
                margin-top: 20px;
                padding-top: 10px;
                border-top: 1px solid #ccc;
                page-break-inside: avoid;
            }
            .teacher-signature { margin-bottom: 30px; font-size: 14px; padding-top: 10px; }

            .info-bar { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; background-color: #e8f6f3 !important; }
            .main-header th { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; background-color: #2c3e50 !important; color: #fff !important; }
        }
    </style>
</head>
<body>

<div class="control-panel">
    <div class="control-header">
        <h2>ğŸ“Š Ù†Ø¸Ø§Ù… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø´Ø§Ù…Ù„</h2>
        <p style="color: #666; font-size: 12px;">Ø£Ø¯Ø§Ø© Ø°ÙƒÙŠØ© ØªØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙˆØªØ¯Ø¹Ù… Ø¬Ù…ÙŠØ¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ù„ÙØ§Øª.</p>
    </div>

    <div class="control-grid">
        <div class="control-group">
            <h3>Ø§Ù„Ø¬Ù‡Ø© (ÙŠÙ…ÙŠÙ†)</h3>
            <input type="text" id="inp_right1" class="input-field" value="Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©" oninput="updateReportDisplay()">
            <input type="text" id="inp_right2" class="input-field" value="ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…" oninput="updateReportDisplay()">
            <input type="text" id="inp_right3" class="input-field" value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±ÙŠØ§Ø¶" oninput="updateReportDisplay()">
        </div>

        <div class="control-group">
            <h3>Ø§Ù„Ù…Ù†ØªØµÙ (Ø§Ù„Ù…Ø¯Ø±Ø³Ø©)</h3>
            <input type="text" id="inp_school" class="input-field" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©..." oninput="updateReportDisplay()">
            <input type="text" id="inp_title" class="input-field" value="ØªÙ‚Ø±ÙŠØ± ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨" readonly style="background: #eee; cursor: not-allowed;">
        </div>

        <div class="control-group">
            <h3>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ÙŠØ³Ø§Ø±)</h3>
            <input type="text" id="inp_year" class="input-field" placeholder="Ø§Ù„Ø¹Ø§Ù…" value="1447" oninput="updateReportDisplay()">
            <input type="text" id="inp_term" class="input-field" placeholder="Ø§Ù„ÙØµÙ„" value="Ø§Ù„Ø£ÙˆÙ„" oninput="updateReportDisplay()">
            <input type="text" id="inp_subject" class="input-field" placeholder="Ø§Ù„Ù…Ø§Ø¯Ø©" oninput="updateReportDisplay()">
        </div>

        <div class="control-group">
            <h3>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„ØµÙ</h3>
            <input type="text" id="inp_grade" class="input-field" placeholder="Ø§Ù„ØµÙ" oninput="updateReportDisplay()">
            <input type="text" id="inp_section" class="input-field" placeholder="Ø§Ù„ÙØµÙ„" oninput="updateReportDisplay()">
            <label style="font-size: 11px; font-weight:bold; display:block; margin-top:5px;">Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¹Ø¸Ù…Ù‰ (Ù„Ù„Ù…ÙˆØ§Ø¯):</label>
            <input type="number" id="inp_max_score" class="input-field" value="100" placeholder="100" onchange="reProcessFile()">
        </div>
    </div>

    <div style="margin-top: 15px; padding: 15px; background: #fffde7; border: 1px solid #eee; border-radius: 8px;">
        <label style="font-weight: bold; font-size: 13px; color: #f39c12;">Ø¹Ù†ÙˆØ§Ù† ÙØ±Ø¹ÙŠ Ù„Ù„ØªÙ‚Ø±ÙŠØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ): </label>
        <input type="text" id="inp_custom_title" class="input-field" style="width: 70%; display: inline-block; margin-right: 10px;" placeholder="Ù…Ø«Ø§Ù„: ØªØ­Ù„ÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ / Ø§Ø®ØªØ¨Ø§Ø± ØªØ´Ø®ÙŠØµÙŠ..." oninput="updateReportDisplay()">
    </div>

    <div style="margin-top: 15px; padding: 15px; background: #fdfefe; border: 1px solid #eee; border-radius: 8px;">
        <label style="font-weight: bold; font-size: 13px;">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…/Ù€Ø©: </label>
        <input type="text" id="inp_teacher" class="input-field" style="width: 50%; display: inline-block; margin-right: 10px;" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§..." oninput="updateReportDisplay()">
    </div>

    <div class="main-actions">
        <input type="file" id="fileUpload" accept=".xlsx, .xls" style="display: none;" onchange="handleFile(this)">
        <button class="btn btn-upload" onclick="document.getElementById('fileUpload').click()">ğŸ“‚ 1. Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„</button>
        <br>
        <span class="hint-text">ğŸ’¡ ÙŠØªØ¹Ø±Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø£Ø¹Ù…Ø¯Ø© (Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ØŒ Ø±ØµØ¯ Ø§Ù„Ø¯Ø±Ø¬Ø§ØªØŒ Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ©)</span>
        <br><br>
        <button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ 2. Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        <button class="btn btn-excel" onclick="exportToExcel()">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„</button>
        <button class="btn btn-img" onclick="downloadChartImage()">ğŸ–¼ï¸ Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ù…</button>
    </div>
</div>

<div class="page-container" id="reportContainer">
    
    <div class="header-section">
        <div class="header-col header-right">
            <div class="header-text" id="out_right1"></div>
            <div class="header-text" id="out_right2"></div>
            <div class="header-text" id="out_right3"></div>
        </div>
        
        <div class="header-col header-center">
            <div style="height: 5px;"></div>
            <div class="header-text" style="font-size: 14px; font-weight: bold;" id="out_school"></div>
            <div class="report-title" id="out_title">ØªÙ‚Ø±ÙŠØ± ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
        </div>

        <div class="header-col header-left">
            <div class="header-text">Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ : <span id="out_year"></span></div>
            <div class="header-text">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ : <span id="out_term"></span></div>
            <div class="header-text">Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© : <span id="out_subject"></span></div>
        </div>
    </div>

    <div class="info-bar">
        <div class="info-item"><span>ğŸ“Œ Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</span> <span id="out_grade">--</span></div>
        <div class="info-item"><span>ğŸ« Ø§Ù„ÙØµÙ„ / Ø§Ù„Ø´Ø¹Ø¨Ø©:</span> <span id="out_section">--</span></div>
        <div class="info-item"><span>ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨:</span> <span id="totalStudents">0</span></div>
    </div>

    <div id="out_custom_title_bar" class="custom-title-bar"></div>

    <div class="table-section">
        <table id="combinedTable">
            <thead>
                <tr class="main-header">
                    <th rowspan="2" style="width: 18%;">Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</th>
                    <th colspan="5" class="col-separator" style="border-left: 2px solid #fff;">Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ (Counts)</th>
                    <th colspan="5">Ø§Ù„Ù†Ø³Ø¨ Ø§Ù„Ù…Ø¦ÙˆÙŠØ© (Percentages)</th>
                </tr>
                <tr class="sub-header">
                    <th>Ø¶Ø¹ÙŠÙ</th>
                    <th>Ù…Ù‚Ø¨ÙˆÙ„</th>
                    <th>Ø¬ÙŠØ¯</th>
                    <th>Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹</th>
                    <th class="col-separator" style="border-left: 2px solid #999;">Ù…Ù…ØªØ§Ø²</th>
                    <th>Ø¶Ø¹ÙŠÙ</th>
                    <th>Ù…Ù‚Ø¨ÙˆÙ„</th>
                    <th>Ø¬ÙŠØ¯</th>
                    <th>Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹</th>
                    <th>Ù…Ù…ØªØ§Ø²</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="11" style="padding: 20px; color: #999;">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="chart-section">
        <div class="chart-container" id="chartWrapper">
            <canvas id="gradesChart"></canvas>
        </div>
        <div id="singleSubjectNote" style="display:none; font-size:10px; color:#777; margin-top:2px;">
            * ØªØ­Ù„ÙŠÙ„ ØªÙØµÙŠÙ„ÙŠ Ù„Ù†Ø³Ø¨ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±Ø§Øª Ù„Ù„Ù…Ø§Ø¯Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©
        </div>
    </div>

    <div class="report-footer">
        <div class="teacher-signature">
            Ù…Ø¹Ù„Ù…/Ù€Ø© Ø§Ù„Ù…Ø§Ø¯Ø©: <span id="out_teacher">.......................</span>
        </div>
        
        <div class="footer-credits">
            <a href="https://gemini.google.com/" target="_blank">Ø¨Ø±Ù…Ø¬Ø© gemini</a>
            <span>|</span>
            <a href="https://t.me/Interact2030" target="_blank">Ù„Ù…Ù„ØªÙ‚Ù‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ</a>
        </div>
    </div>

</div>

<script>
    let globalCounts = {};
    let globalTotalStudents = 0;
    let globalSubjects = [];
    let currentWorkbook = null;
    const gradesOrder = ["Ø¶Ø¹ÙŠÙ", "Ù…Ù‚Ø¨ÙˆÙ„", "Ø¬ÙŠØ¯", "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹", "Ù…Ù…ØªØ§Ø²"];

    window.onload = function() {
        updateReportDisplay();
    };

    function updateReportDisplay() {
        document.getElementById('out_right1').innerText = document.getElementById('inp_right1').value;
        document.getElementById('out_right2').innerText = document.getElementById('inp_right2').value;
        document.getElementById('out_right3').innerText = document.getElementById('inp_right3').value;
        
        document.getElementById('out_school').innerText = document.getElementById('inp_school').value;
        
        document.getElementById('out_year').innerText = document.getElementById('inp_year').value;
        document.getElementById('out_term').innerText = document.getElementById('inp_term').value;
        document.getElementById('out_subject').innerText = document.getElementById('inp_subject').value;
        
        document.getElementById('out_grade').innerText = document.getElementById('inp_grade').value;
        document.getElementById('out_section').innerText = document.getElementById('inp_section').value;
        
        // Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠ
        const customTitleVal = document.getElementById('inp_custom_title').value;
        const customTitleBar = document.getElementById('out_custom_title_bar');
        
        if(customTitleVal && customTitleVal.trim() !== "") {
            customTitleBar.innerText = customTitleVal;
            customTitleBar.style.display = 'block';
        } else {
            customTitleBar.style.display = 'none';
        }

        const teacherVal = document.getElementById('inp_teacher').value;
        document.getElementById('out_teacher').innerText = teacherVal ? teacherVal : ".......................";
    }

    function toArabicNumerals(str) {
        if (str === null || str === undefined) return "";
        str = str.toString();
        const map = ["Ù ", "Ù¡", "Ù¢", "Ù£", "Ù¤", "Ù¥", "Ù¦", "Ù§", "Ù¨", "Ù©"];
        return str.replace(/[0-9]/g, d => map[d]);
    }

    function handleFile(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            currentWorkbook = workbook;
            
            autoFillInputs(workbook);
            processDataHybrid(workbook); 
            updateReportDisplay();
        };
        reader.readAsArrayBuffer(file);
    }

    function reProcessFile() {
        if(currentWorkbook) {
            processDataHybrid(currentWorkbook);
        }
    }

    function autoFillInputs(workbook) {
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, {header: 1});
        const limit = Math.min(json.length, 35);
        
        let foundSchool = "";
        let foundGrade = "";
        
        for (let i = 0; i < limit; i++) {
            const row = json[i];
            if (!row) continue;
            row.forEach(cell => {
                if (typeof cell !== 'string') return;
                const txt = cell.trim();
                
                if ((txt.includes("Ù…Ø¯Ø±Ø³Ø©") || txt.includes("Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©") || txt.includes("Ù…ØªÙˆØ³Ø·Ø©") || txt.includes("Ø«Ø§Ù†ÙˆÙŠØ©")) && !txt.includes("Ù…Ø¯ÙŠØ±")) {
                   if (!txt.includes("Ø§Ù„Ø±ÙŠØ§Ø¶") && !txt.includes("ØªØ¹Ù„ÙŠÙ…")) {
                       foundSchool = txt;
                   }
                }
                
                if (i >= 5 && (txt.includes("Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ") || txt.includes("Ø§Ù„Ù…ØªÙˆØ³Ø·") || txt.includes("Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ"))) {
                    foundGrade = txt;
                }
            });
        }
        
        if (foundSchool) document.getElementById('inp_school').value = foundSchool;
        if (foundGrade) document.getElementById('inp_grade').value = foundGrade;
        document.getElementById('inp_section').value = "1";
    }

    function processDataHybrid(workbook) {
        globalCounts = {};
        globalTotalStudents = 0;
        globalSubjects = [];

        let fileType = "unknown";
        let scoreColumnIndex = -1;
        
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
        
        const scoreKeywords = ["Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹", "Ø±ØµØ¯ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª", "Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ©", "Ø§Ù„Ø¯Ø±Ø¬Ø©", "Total", "Score", "Mark"];

        for(let r=0; r < Math.min(json.length, 40); r++) {
            if(!json[r]) continue;
            for(let c=0; c < json[r].length; c++) {
                let cellVal = (json[r][c] || "").toString().trim();
                
                if(gradesOrder.includes(cellVal)) {
                    fileType = "grades_text";
                    break;
                }
                
                if(scoreKeywords.some(keyword => cellVal.includes(keyword) || cellVal === keyword)) {
                    fileType = "scores_numeric";
                    scoreColumnIndex = c;
                }
            }
            if(fileType === "grades_text") break;
        }

        if(fileType === "unknown" || (fileType === "scores_numeric" && scoreColumnIndex === -1)) {
            let maxScoreFound = 0;
            let bestColIndex = -1;

            for(let c=0; c < 50; c++) { 
                let numericCount = 0;
                let currentMax = 0;
                for(let r=5; r < Math.min(json.length, 100); r++) { 
                    if(json[r] && !isNaN(parseFloat(json[r][c]))) {
                        let val = parseFloat(json[r][c]);
                        if(val > 0 && val <= 1000) { 
                            numericCount++;
                            if(val > currentMax) currentMax = val;
                        }
                    }
                }
                if(numericCount > 5 && currentMax > maxScoreFound) {
                    maxScoreFound = currentMax;
                    bestColIndex = c;
                }
            }

            if(bestColIndex !== -1) {
                fileType = "scores_numeric";
                scoreColumnIndex = bestColIndex;
            }
        }

        if (fileType === "grades_text") {
            processTextGrades(workbook);
        } else if (fileType === "scores_numeric" && scoreColumnIndex !== -1) {
            processNumericScores(workbook, scoreColumnIndex);
        } else {
            processTextGrades(workbook); 
        }

        document.getElementById('totalStudents').innerText = toArabicNumerals(globalTotalStudents);
        
        if (globalTotalStudents > 0) {
            renderCombinedTable();
            renderChartSmart();
        } else {
            alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ø¶Ø­Ø©.");
        }
    }

    function processTextGrades(workbook) {
        let detectedSubjects = [];
        const gradeCol = 23; 
        const subjectColAr = 46; 
        const subjectColEn = 17; 
        
        for(let sName of workbook.SheetNames) {
            const sheet = workbook.Sheets[sName];
            const json = XLSX.utils.sheet_to_json(sheet, {header: 1});
            if (json.length < 20) continue;

            for(let r=0; r < Math.min(json.length, 100); r++) {
                if(!json[r]) continue;
                let grade = (json[r][gradeCol] || "").toString().trim();
                if(gradesOrder.includes(grade)) {
                    let subjName = json[r][subjectColAr];
                    if(!subjName) subjName = json[r][subjectColEn];
                    if(typeof subjName === 'string' && subjName.trim().length > 0) {
                        let cleanName = subjName.trim();
                        if(!detectedSubjects.includes(cleanName)) detectedSubjects.push(cleanName);
                    }
                }
            }
            if(detectedSubjects.length > 0) break;
        }

        globalSubjects = detectedSubjects.length > 0 ? detectedSubjects : ["Ø¹Ø§Ù…"];
        updateSubjectInput();

        globalSubjects.forEach(s => globalCounts[s] = { "Ø¶Ø¹ÙŠÙ": 0, "Ù…Ù‚Ø¨ÙˆÙ„": 0, "Ø¬ÙŠØ¯": 0, "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹": 0, "Ù…Ù…ØªØ§Ø²": 0 });

        workbook.SheetNames.forEach(sheetName => {
            const sheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(sheet, {header: 1});
            if (json.length < 20) return;

            let studentProcessed = false;
            for(let r=0; r < json.length; r++) {
                if(!json[r]) continue;
                let grade = (json[r][gradeCol] || "").toString().trim();
                if(gradesOrder.includes(grade)) {
                    let subjName = json[r][subjectColAr];
                    if(!subjName) subjName = json[r][subjectColEn];
                    if(typeof subjName === 'string') {
                        subjName = subjName.trim();
                        if(globalCounts[subjName]) {
                            globalCounts[subjName][grade]++;
                            studentProcessed = true;
                        }
                    }
                }
            }
            if(studentProcessed) globalTotalStudents++;
        });
    }

    function processNumericScores(workbook, scoreColIdx) {
        let subjectName = "Ø§Ù„Ù…Ø§Ø¯Ø©";
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, {header: 1});
        
        for(let r=0; r < Math.min(json.length, 30); r++) {
            if(!json[r]) continue;
            for(let c=0; c < json[r].length; c++) {
                let txt = (json[r][c] || "").toString();
                if(txt.includes("Ø§Ù„Ù…Ø§Ø¯Ø©") || txt.includes("Ù…Ø§Ø¯Ø©")) { } 
                if(["Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©", "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "Ù„ØºØªÙŠ", "Ø¹Ù„ÙˆÙ…", "ÙÙ‚Ù‡", "ØªÙˆØ­ÙŠØ¯"].some(s => txt.includes(s))) {
                    subjectName = txt;
                }
            }
        }
        
        globalSubjects = [subjectName];
        updateSubjectInput();
        globalCounts[subjectName] = { "Ø¶Ø¹ÙŠÙ": 0, "Ù…Ù‚Ø¨ÙˆÙ„": 0, "Ø¬ÙŠØ¯": 0, "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹": 0, "Ù…Ù…ØªØ§Ø²": 0 };

        let maxScoreInput = parseFloat(document.getElementById('inp_max_score').value) || 100;

        workbook.SheetNames.forEach(sheetName => {
            const sheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(sheet, {header: 1});
            
            for(let r=0; r < json.length; r++) {
                if(!json[r]) continue;
                let cellVal = json[r][scoreColIdx];
                
                if(typeof cellVal === 'string' && isNaN(parseFloat(cellVal))) continue;

                let score = parseFloat(cellVal);
                if(!isNaN(score) && score >= 0 && score <= maxScoreInput * 1.5) { 
                    let grade = getGradeFromScore(score, maxScoreInput);
                    globalCounts[subjectName][grade]++;
                    globalTotalStudents++; 
                }
            }
        });
    }

    function getGradeFromScore(score, maxScore) {
        let percent = (score / maxScore) * 100;
        if (percent >= 90) return "Ù…Ù…ØªØ§Ø²";
        if (percent >= 80) return "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹";
        if (percent >= 65) return "Ø¬ÙŠØ¯";
        if (percent >= 50) return "Ù…Ù‚Ø¨ÙˆÙ„";
        return "Ø¶Ø¹ÙŠÙ";
    }

    function updateSubjectInput() {
        const subjectInput = document.getElementById('inp_subject');
        if (globalSubjects.length === 1) {
            subjectInput.value = globalSubjects[0];
        } else {
            subjectInput.value = "Ø¹Ø§Ù… / Ø´Ø§Ù…Ù„";
        }
    }

    function renderCombinedTable() {
        const tbody = document.querySelector('#combinedTable tbody');
        tbody.innerHTML = "";
        globalSubjects.forEach(subject => {
            let tr = `<tr>`;
            tr += `<td style="font-weight:bold; text-align:right;">${subject}</td>`;
            gradesOrder.forEach((g, idx) => {
                const val = globalCounts[subject][g] || 0;
                const borderStyle = (idx === gradesOrder.length - 1) ? 'border-left: 2px solid #999;' : '';
                tr += `<td style="${borderStyle}">${toArabicNumerals(val)}</td>`;
            });
            gradesOrder.forEach(g => {
                const val = globalCounts[subject][g] || 0;
                const pct = globalTotalStudents > 0 ? ((val/globalTotalStudents)*100).toFixed(1) : "0";
                tr += `<td>${toArabicNumerals(pct)}%</td>`;
            });
            tr += `</tr>`;
            tbody.innerHTML += tr;
        });
    }

    function renderChartSmart() {
        const ctx = document.getElementById('gradesChart').getContext('2d');
        const colors = { "Ù…Ù…ØªØ§Ø²": "#27ae60", "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹": "#2980b9", "Ø¬ÙŠØ¯": "#f1c40f", "Ù…Ù‚Ø¨ÙˆÙ„": "#e67e22", "Ø¶Ø¹ÙŠÙ": "#c0392b" };

        if (window.myChart) window.myChart.destroy();
        Chart.defaults.font.family = "'Cairo', sans-serif";
        
        if (globalSubjects.length === 1) {
            document.getElementById('chartWrapper').style.width = "50%"; 
            document.getElementById('chartWrapper').style.margin = "0 auto";
            document.getElementById('singleSubjectNote').style.display = "block";

            const subject = globalSubjects[0];
            const dataValues = gradesOrder.map(g => globalCounts[subject][g]);
            const bgColors = gradesOrder.map(g => colors[g]);

            window.myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: gradesOrder,
                    datasets: [{
                        data: dataValues,
                        backgroundColor: bgColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', rtl: true, labels: { font: { size: 10 } } },
                        title: { display: true, text: 'ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±Ø§Øª: ' + subject, font: { size: 14 } }
                    }
                }
            });

        } else {
            document.getElementById('chartWrapper').style.width = "100%";
            document.getElementById('singleSubjectNote').style.display = "none";

            const datasets = gradesOrder.reverse().map(g => ({
                label: g,
                data: globalSubjects.map(s => globalCounts[s][g]),
                backgroundColor: colors[g],
                borderWidth: 1
            }));

            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: globalSubjects, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { font: { size: 9, weight: 'bold' } }, grid: { display: false } },
                        y: { position: 'right', ticks: { callback: v => toArabicNumerals(v) }, title: { display: true, text: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨' } }
                    },
                    plugins: {
                        legend: { position: 'top', rtl: true, labels: { boxWidth: 10, font: { size: 10 } } },
                        title: { display: true, text: 'ØªØ­Ù„ÙŠÙ„ Ù…Ù‚Ø§Ø±Ù† Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯' }
                    }
                }
            });
        }
    }

    function exportToExcel() {
        if (globalTotalStudents === 0) { alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª"); return; }
        let dataForExcel = [];
        globalSubjects.forEach(subject => {
            let rowObj = { "Ø§Ù„Ù…Ø§Ø¯Ø©": subject };
            gradesOrder.forEach(g => rowObj[`Ø¹Ø¯Ø¯ (${g})`] = globalCounts[subject][g]);
            gradesOrder.forEach(g => {
                const val = globalCounts[subject][g];
                rowObj[`Ù†Ø³Ø¨Ø© (${g}) %`] = globalTotalStudents > 0 ? ((val/globalTotalStudents)*100).toFixed(1)+"%" : "0%";
            });
            dataForExcel.push(rowObj);
        });
        const ws = XLSX.utils.json_to_sheet(dataForExcel);
        const wscols = [{wch: 30}]; 
        for(let i=0; i<10; i++) wscols.push({wch: 10});
        ws['!cols'] = wscols;
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„ØªØ­Ù„ÙŠÙ„");
        XLSX.writeFile(wb, "ØªØ­Ù„ÙŠÙ„_Ø§Ù„Ù†ØªØ§Ø¦Ø¬.xlsx");
    }

    function downloadChartImage() {
        const canvas = document.getElementById('gradesChart');
        const link = document.createElement('a');
        link.download = 'chart-analysis.png';
        link.href = canvas.toDataURL('image/png', 1.0);
        link.click();
    }
</script>

</body>
</html>