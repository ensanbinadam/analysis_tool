<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Ù†Ø¸Ø§Ù… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø´Ø§Ù…Ù„ - Ø£Ø¯Ø§Ø© Ù…ØªÙ‚Ø¯Ù…Ø© Ù„ØªØ­Ù„ÙŠÙ„ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©.">
    <meta name="keywords" content="ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬, Ù†Ø¸Ø§Ù… Ù†ÙˆØ±, Ø¥Ø­ØµØ§Ø¡Ø§Øª ØªØ¹Ù„ÙŠÙ…ÙŠØ©, Ø±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ©, ØªÙ‚Ø§Ø±ÙŠØ± Ø·Ù„Ø§Ø¨">
    <meta property="og:title" content="Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„ V20">
    <meta property="og:description" content="Ø£Ø¯Ø§Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© Ù…Ø¹ Ø¯Ø¹Ù… ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø±Ù‚Ù…ÙŠ.">
    <meta property="og:type" content="website">
    
    <!-- Favicon: Simple Chart Icon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“Š</text></svg>">

    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„ - V20.6 (Premium)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary-color: #0f172a;       /* Slate 900 */
            --secondary-color: #334155;     /* Slate 700 */
            --accent-color: #2563eb;        /* Blue 600 */
            --accent-hover: #1d4ed8;        /* Blue 700 */
            --success-color: #059669;       /* Emerald 600 */
            --warning-color: #d97706;       /* Amber 600 */
            --danger-color: #dc2626;        /* Red 600 */
            --bg-color: #f1f5f9;            /* Slate 100 */
            --card-bg: #ffffff;
            --border-color: #e2e8f0;        /* Slate 200 */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
        }
        
        * { box-sizing: border-box; }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 40px 20px;
            color: #1e293b;
            direction: rtl;
            line-height: 1.6;
        }

        /* --- UI Components --- */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .btn:active { transform: translateY(0); }
        
        .btn-primary { background-color: var(--accent-color); }
        .btn-primary:hover { background-color: var(--accent-hover); }
        
        .btn-success { background-color: var(--success-color); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-dark { background-color: var(--primary-color); }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--secondary-color);
        }
        .btn-outline:hover { background: #f8fafc; border-color: var(--accent-color); color: var(--accent-color); }

        /* --- Control Panel --- */
        .control-panel {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            max-width: 1100px;
            margin: 0 auto 40px auto;
            border: 1px solid var(--border-color);
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .panel-title h2 { margin: 0; color: var(--primary-color); font-size: 24px; font-weight: 800; display: flex; align-items: center; gap: 10px; }
        .panel-title p { margin: 5px 0 0 0; color: #64748b; font-size: 13px; }

        .settings-actions { display: flex; gap: 10px; }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }
        .control-group:hover { border-color: #cbd5e1; box-shadow: var(--shadow-sm); }
        
        .control-group h3 { 
            margin-top: 0; 
            font-size: 14px; 
            color: var(--accent-color); 
            margin-bottom: 15px; 
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .input-wrapper { margin-bottom: 10px; }
        .input-field {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-family: 'Cairo';
            font-size: 13px;
            box-sizing: border-box;
            transition: all 0.2s;
            background: #fff;
        }
        .input-field:focus { 
            border-color: var(--accent-color); 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); 
        }
        .input-field::placeholder { color: #94a3b8; }

        .options-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .option-card {
            background: #fff8e1; /* Light Amber for warning/info */
            border: 1px solid #fcd34d;
            padding: 15px;
            border-radius: 10px;
        }
        .option-card.blue { background: #eff6ff; border-color: #bfdbfe; }

        .main-actions {
            background: #f1f5f9;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            align-items: center;
        }

        /* --- Report Container (A4) --- */
        .page-container {
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            background: #fff;
            padding: 15mm;
            box-shadow: var(--shadow-lg);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .header-col { flex: 1; text-align: center !important; } 
        
        .header-text { font-size: 13px; font-weight: 600; color: #334155; margin-bottom: 4px; }
        .report-title { 
            font-weight: 800; 
            font-size: 18px; 
            color: var(--primary-color); 
            margin-bottom: 5px;
            white-space: nowrap; 
        }

        .info-bar {
            background-color: #f1f5f9;
            color: var(--primary-color);
            border: 1px solid #e2e8f0;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            font-weight: 700;
            font-size: 13px;
        }

        .custom-title-bar {
            background-color: #fffbeb;
            color: #92400e;
            border: 1px solid #fde68a;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            font-size: 15px;
            display: none; 
        }

        /* Table */
        .table-section { margin-bottom: 20px; text-align: center; } 
        table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 11px; 
            font-family: 'Inter', 'Cairo', sans-serif; 
            margin: 0 auto; 
        }
        th, td { border: 1px solid #cbd5e1; padding: 6px 8px; text-align: center; }
        
        /* Premium Table Header */
        .main-header th { 
            background-color: var(--primary-color); 
            color: #fff; 
            font-weight: 700;
        }
        .sub-header th { 
            background-color: #f8fafc; 
            color: #475569; 
            font-size: 11px; 
            font-weight: 600; 
        }
        
        tr:nth-child(even) { background-color: #f8fafc; }

        .grade-cell { font-family: 'Inter', sans-serif; font-weight: 600; }
        .percent-cell { font-family: 'Inter', sans-serif; font-weight: 700; color: var(--accent-color); }

        /* Chart */
        .chart-section {
            flex-grow: 1;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            background: #fff;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 300px;
            display: flex;
            justify-content: center;
        }

        /* Footer */
        .report-footer {
            margin-top: auto; 
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        .teacher-signature {
            font-weight: bold;
            font-size: 14px;
            color: var(--primary-color);
        }
        .footer-credits {
            font-size: 10px;
            color: #94a3b8;
        }
        .footer-credits a { color: var(--accent-color); text-decoration: none; font-weight: 600; }

        /* --- Print Styles (V20.2 Refined) --- */
        @media print {
            @page { size: A4; margin: 0; } /* Zero margin at page level */
            body { 
                background: none; 
                padding: 0; 
                margin: 0; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact; 
                width: 210mm;
                height: 100%;
            }
            .control-panel { display: none !important; }
            .page-container { 
                width: 210mm; 
                height: 280mm; /* Fix 4: Reduced height to prevent overflow/blank page */
                padding: 10mm; 
                margin: 0 auto; 
                border: none; 
                box-shadow: none; 
                display: block; 
                overflow: hidden; 
                position: relative; /* Context for absolute footer */
            }
            .header-section { border-bottom: 2px solid var(--primary-color) !important; margin-bottom: 10px; padding-bottom: 5px; }
            .info-bar { background-color: #f1f5f9 !important; border-color: #e2e8f0 !important; margin-bottom: 15px; padding: 5px; }
            .main-header th { background-color: #0f172a !important; color: #fff !important; }
            .sub-header th { background-color: #f8fafc !important; }
            
            .chart-section { border: none; padding: 0; margin-bottom: 10px; }
            .chart-container { height: 210px !important; } /* Compact chart */
            
            .table-section { margin-bottom: 15px; }
            table { font-size: 10px; }
            th, td { padding: 4px; }
            
        /* Fix 3: Absolute Footer */
            .report-footer { 
                position: absolute;
                bottom: 10mm;
                left: 10mm;
                right: 10mm;
                border-top: 1px solid #aaa;
                padding-top: 10px;
                margin-top: 0;
            }

            /* Fix 5: Prevent Chart Overlap with Caption */
            .chart-container canvas {
                max-height: 100% !important; /* Force chart to fit in 210px container */
                width: auto !important;
                margin: 0 auto;
            }
            #singleSubjectNote {
                margin-top: 15px !important;
                position: relative !important;
                z-index: 10;
                display: block; /* Will respect JS display property, but this ensures block model if visible */
                background: white !important; /* Ensure text is visible if overlap persists */ 
            }
        }
    </style>
</head>
<body>

<div class="control-panel">
    <div class="panel-header">
        <div class="panel-title">
            <h2><span>ğŸ“Š</span> Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„ <span style="font-size: 14px; background: var(--warning-color); color: #fff; padding: 2px 8px; border-radius: 20px; margin-right: 10px;">V20.6</span></h2>
            <p>Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø·ÙˆØ±Ù‘Ø©: (Premium+)</p>
        </div>
        <div class="settings-actions">
            <button class="btn btn-outline btn-small" onclick="saveSettings()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            <button class="btn btn-outline btn-small" onclick="clearSettings()" style="color: var(--danger-color); border-color: #fee2e2;">ğŸ§¹ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
        </div>
    </div>

    <div class="control-grid">
        <div class="control-group">
            <h3>ğŸ”¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù‡Ø© (Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©)</h3>
            <div class="input-wrapper"><input type="text" id="inp_right1" class="input-field" value="Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©" oninput="updateReportDisplay()"></div>
            <div class="input-wrapper"><input type="text" id="inp_right2" class="input-field" value="ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…" oninput="updateReportDisplay()"></div>
            <div class="input-wrapper"><input type="text" id="inp_right3" class="input-field" value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±ÙŠØ§Ø¶" oninput="updateReportDisplay()"></div>
        </div>

        <div class="control-group">
            <h3>ğŸ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</h3>
            <div class="input-wrapper"><input type="text" id="inp_school" class="input-field" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©..." oninput="updateReportDisplay()"></div>
            <div class="input-wrapper"><input type="text" id="inp_title" class="input-field" value="ØªÙ‚Ø±ÙŠØ± ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨" readonly style="background: #f1f5f9; color: #64748b;"></div>
        </div>

        <div class="control-group">
            <h3>ğŸ“… Ø§Ù„Ø¹Ø§Ù… ÙˆØ§Ù„ÙØµÙ„</h3>
            <div class="input-wrapper"><input type="text" id="inp_year" class="input-field" placeholder="Ø§Ù„Ø¹Ø§Ù… (Ù…Ø«Ø§Ù„: 1447)" value="1447" oninput="updateReportDisplay()"></div>
            <div class="input-wrapper"><input type="text" id="inp_term" class="input-field" placeholder="Ø§Ù„ÙØµÙ„ (Ù…Ø«Ø§Ù„: Ø§Ù„Ø£ÙˆÙ„)" value="Ø§Ù„Ø£ÙˆÙ„" oninput="updateReportDisplay()"></div>
            <div class="input-wrapper"><input type="text" id="inp_subject" class="input-field" placeholder="Ø§Ù„Ù…Ø§Ø¯Ø© (ÙŠØªÙ… Ø§Ù„ØªØ¹Ø¨Ø¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)" oninput="updateReportDisplay()"></div>
        </div>

        <div class="control-group">
            <h3>âš™ï¸ Ø§Ù„Ø¶Ø¨Ø· ÙˆØ§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±</h3>
            <div class="input-wrapper"><input type="text" id="inp_grade" class="input-field" placeholder="Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ" oninput="updateReportDisplay()"></div>
            <div class="input-wrapper"><input type="text" id="inp_section" class="input-field" placeholder="Ø§Ù„ÙØµÙ„/Ø§Ù„Ø´Ø¹Ø¨Ø©" oninput="updateReportDisplay()"></div>
            <div class="input-wrapper">
                <label style="font-size: 11px; font-weight:bold; color: var(--secondary-color);">Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¹Ø¸Ù…Ù‰:</label>
                <input type="number" id="inp_max_score" class="input-field" value="100" onchange="reProcessFiles()">
            </div>
        </div>
    </div>

    <div class="options-area">
        <div class="option-card">
            <label style="font-weight: bold; font-size: 13px; color: #92400e; display: block; margin-bottom: 5px;">Ø¹Ù†ÙˆØ§Ù† ÙØ±Ø¹ÙŠ Ù…Ø®ØµØµ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input type="text" id="inp_custom_title" class="input-field" placeholder="Ù…Ø«Ø§Ù„: ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙØªØ±Ø§Øª / Ù†ØªØ§Ø¦Ø¬ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù†ØªØµÙ Ø§Ù„ÙØµÙ„..." oninput="updateReportDisplay()">
        </div>
        
        <div class="option-card blue">
            <label style="font-weight: bold; font-size: 13px; color: #1e40af; display: block; margin-bottom: 5px;">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…/Ù€Ø©</label>
            <input type="text" id="inp_teacher" class="input-field" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ±ÙŠÙ…..." oninput="updateReportDisplay()">
        </div>
    </div>

    <div class="main-actions">
        <button class="btn" style="background-color: #fee2e2; color: #dc2626; border: 1px solid #fca5a5;" onclick="location.reload()">
            ğŸ”„ ØªØ­Ù„ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
        </button>
        <input type="file" id="fileUpload" accept=".xlsx, .xls" style="display: none;" multiple onchange="handleFiles(this)">
        <button class="btn btn-primary" onclick="document.getElementById('fileUpload').click()">
            ğŸ“‚ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥ÙƒØ³Ù„
        </button>
        <button class="btn btn-dark" onclick="window.print()">
            ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        </button>
        <button class="btn btn-success" onclick="exportToExcel()">
            ğŸ“¥ ØªØµØ¯ÙŠØ± Excel
        </button>
        <button class="btn btn-outline" style="background:white; color: #7e22ce; border-color: #7e22ce;" onclick="downloadChartImage()">
            ğŸ–¼ï¸ Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
        </button>
    </div>
</div>

<!-- Report Page -->
<div class="page-container" id="reportContainer">
    
    <div class="header-section">
        <div class="header-col header-right">
            <div class="header-text" id="out_right1"></div>
            <div class="header-text" id="out_right2"></div>
            <div class="header-text" id="out_right3"></div>
        </div>
        
        <div class="header-col header-center">
            <div class="report-title" id="out_title">ØªÙ‚Ø±ÙŠØ± ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
            <div class="header-text" style="font-size: 15px; font-weight: bold; color: var(--accent-color);" id="out_school"></div>
        </div>

        <div class="header-col header-left">
            <div class="header-text">Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ : <span id="out_year"></span></div>
            <div class="header-text">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ : <span id="out_term"></span></div>
            <div class="header-text">Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© : <span id="out_subject"></span></div>
        </div>
    </div>

    <div class="info-bar">
        <div class="info-item"><span>ğŸ“Œ Ø§Ù„ØµÙ:</span> <span id="out_grade">--</span></div>
        <div class="info-item"><span>ğŸ« Ø§Ù„ÙØµÙ„/Ø§Ù„Ø´Ø¹Ø¨Ø©:</span> <span id="out_section">--</span></div>
        <div class="info-item"><span>ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ (Ø§Ù„Ø£Ø¹Ù„ÙŠ):</span> <span id="totalStudents">0</span></div>
    </div>

    <div id="out_custom_title_bar" class="custom-title-bar"></div>

    <div class="table-section">
        <table id="combinedTable">
            <thead>
                <tr class="main-header">
                    <th rowspan="2" style="width: 18%;">Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</th>
                    <th colspan="5" style="border-left: 2px solid rgba(255,255,255,0.2);">Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ (Counts)</th>
                    <th colspan="5">Ø§Ù„Ù†Ø³Ø¨ Ø§Ù„Ù…Ø¦ÙˆÙŠØ© (Percentages)</th>
                </tr>
                <tr class="sub-header">
                    <th>Ø¶Ø¹ÙŠÙ</th>
                    <th>Ù…Ù‚Ø¨ÙˆÙ„</th>
                    <th>Ø¬ÙŠØ¯</th>
                    <th>Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹</th>
                    <th style="border-left: 2px solid #cbd5e1;">Ù…Ù…ØªØ§Ø²</th>
                    <th>Ø¶Ø¹ÙŠÙ</th>
                    <th>Ù…Ù‚Ø¨ÙˆÙ„</th>
                    <th>Ø¬ÙŠØ¯</th>
                    <th>Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹</th>
                    <th>Ù…Ù…ØªØ§Ø²</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="11" style="padding: 30px; color: #94a3b8; font-style: italic;">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="chart-section">
        <div class="chart-container" id="chartWrapper">
            <canvas id="gradesChart"></canvas>
        </div>
        <div id="singleSubjectNote" style="display:none; font-size:11px; color:#64748b; margin-top:5px; background: #f1f5f9; padding: 2px 8px; border-radius: 4px;">
            * Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ ÙŠÙˆØ¶Ø­ Ù†Ø³Ø¨ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±Ø§Øª Ù„Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
        </div>
    </div>

    <div class="report-footer">
        <div class="teacher-signature">
            Ù…Ø¹Ù„Ù…/Ù€Ø© Ø§Ù„Ù…Ø§Ø¯Ø©: <span id="out_teacher" class="teacher-name-box"></span>
        </div>
        
        <div class="footer-credits">
            ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙˆØ§Ø³Ø·Ø©: <a href="https://gemini.google.com/" target="_blank">Gemini 2.0</a>
            <span style="margin: 0 5px; color: #cbd5e1;">|</span>
            <a href="https://t.me/Interact2030" target="_blank">Ø­Ù‚ÙˆÙ‚ Ø§Ù„ØªØ·ÙˆÙŠØ± Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„Ù…Ù„ØªÙ‚Ù‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ</a>
        </div>
    </div>
</div>

<script>
    // === Core Logic Data ===
    let globalCounts = {};
    let subjectTotals = {}; 
    let globalTotalStudents = 0; 
    let globalSubjects = [];
    let loadedWorkbooks = [];
    
    // Fix 3 (Restoration): Filter out garbage text BUT RENAME instead of ignoring
    const IGNORED_SUBJECTS = ["MonitoringHasRevealedDegreesOfM", "Monitoring", "Undefined", "null"];
    
    const gradesOrder = ["Ø¶Ø¹ÙŠÙ", "Ù…Ù‚Ø¨ÙˆÙ„", "Ø¬ÙŠØ¯", "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹", "Ù…Ù…ØªØ§Ø²"];
    const gradeColors = { 
        "Ù…Ù…ØªØ§Ø²": "#059669", 
        "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹": "#2563eb", 
        "Ø¬ÙŠØ¯": "#fbbf24", 
        "Ù…Ù‚Ø¨ÙˆÙ„": "#ea580c", 
        "Ø¶Ø¹ÙŠÙ": "#dc2626" 
    };

    // === Initialization ===
    window.onload = function() {
        loadSettings();
        updateReportDisplay();
    };

    // === Settings Management ===
    function saveSettings() {
        try {
            const settings = {
                right1: valueOf('inp_right1'),
                right2: valueOf('inp_right2'),
                right3: valueOf('inp_right3'),
                school: valueOf('inp_school'),
                year: valueOf('inp_year'),
                term: valueOf('inp_term'),
                subject: valueOf('inp_subject'),
                grade: valueOf('inp_grade'),
                section: valueOf('inp_section'),
                maxScore: valueOf('inp_max_score'),
                customTitle: valueOf('inp_custom_title'),
                teacher: valueOf('inp_teacher')
            };
            localStorage.setItem('analysisToolV20', JSON.stringify(settings));
            alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
        } catch (e) { console.error(e); }
    }

    function loadSettings() {
        try {
            const saved = localStorage.getItem('analysisToolV20');
            if (saved) {
                const s = JSON.parse(saved);
                setVal('inp_right1', s.right1);
                setVal('inp_right2', s.right2);
                setVal('inp_right3', s.right3);
                setVal('inp_school', s.school);
                setVal('inp_year', s.year);
                setVal('inp_term', s.term);
                setVal('inp_subject', s.subject);
                setVal('inp_grade', s.grade);
                setVal('inp_section', s.section);
                setVal('inp_max_score', s.maxScore || 100);
                setVal('inp_custom_title', s.customTitle);
                setVal('inp_teacher', s.teacher);
            }
        } catch (e) {}
    }

    function clearSettings() {
        if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')) {
            localStorage.removeItem('analysisToolV20');
            location.reload();
        }
    }

    function valueOf(id) { return document.getElementById(id).value; }
    function setVal(id, val) { if(val !== undefined) document.getElementById(id).value = val; }

    // === UI Updates ===
    function updateReportDisplay() {
        document.getElementById('out_right1').innerText = valueOf('inp_right1');
        document.getElementById('out_right2').innerText = valueOf('inp_right2');
        document.getElementById('out_right3').innerText = valueOf('inp_right3');
        document.getElementById('out_school').innerText = valueOf('inp_school');
        document.getElementById('out_year').innerText = valueOf('inp_year');
        document.getElementById('out_term').innerText = valueOf('inp_term');
        
        // Fix (V20.6): Subject Sync Logic - Real-time updates
        const subjInput = valueOf('inp_subject');
        document.getElementById('out_subject').innerText = subjInput; 

        document.getElementById('out_grade').innerText = valueOf('inp_grade') || "--";
        document.getElementById('out_section').innerText = valueOf('inp_section') || "--";
        
        const customTitle = valueOf('inp_custom_title');
        const bar = document.getElementById('out_custom_title_bar');
        if(customTitle && customTitle.trim()) {
            bar.innerText = customTitle;
            bar.style.display = 'block';
        } else {
            bar.style.display = 'none';
        }

        const teacherInput = valueOf('inp_teacher');
        const teacherOut = document.getElementById('out_teacher');
        if (teacherInput && teacherInput.trim() !== "") {
            teacherOut.innerText = teacherInput;
            teacherOut.style.borderBottom = "none";
        } else {
            teacherOut.innerText = ".......................";
            teacherOut.style.borderBottom = "1px dashed #ccc";
        }

        // Trigger Repaint of Table and Chart to reflect name change instantly
        if(globalSubjects.length > 0) {
            renderCombinedTable(); 
            renderChart();
        }
    }

    function toArabicNumerals(str) {
        if (str == null) return "0";
        str = str.toString();
        const map = ["Ù ", "Ù¡", "Ù¢", "Ù£", "Ù¤", "Ù¥", "Ù¦", "Ù§", "Ù¨", "Ù©"];
        return str.replace(/[0-9]/g, d => map[d]);
    }

    // === File Processing ===
    async function handleFiles(input) {
        if (input.files.length === 0) return;
        
        // Reset visually immediately
        document.querySelector('#combinedTable tbody').innerHTML = '<tr><td colspan="11">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</td></tr>';
        if (window.myChart) window.myChart.destroy();
        
        resetData();
        const promises = Array.from(input.files).map(file => readFileAsync(file));
        loadedWorkbooks = await Promise.all(promises);

        if (!localStorage.getItem('analysisToolV20') && loadedWorkbooks.length > 0) {
             autoFillInputs(loadedWorkbooks[0]);
        }

        processAllWorkbooks(loadedWorkbooks);
        
        // Fix 3 (Reset): Clear input so onchange fires again easily
        input.value = '';
    }

    function resetData() {
        globalCounts = {};
        subjectTotals = {};
        globalTotalStudents = 0;
        globalSubjects = [];
    }

    function readFileAsync(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(XLSX.read(e.target.result, {type: 'array'}));
            reader.onerror = reject;
            reader.readAsArrayBuffer(file);
        });
    }

    function reProcessFiles() {
        if(loadedWorkbooks.length > 0) {
            resetData();
            processAllWorkbooks(loadedWorkbooks);
        }
    }

    function processAllWorkbooks(workbooks) {
        workbooks.forEach(wb => processWorkbook(wb));
        
        // Fix 2: Student Count - Use Max of Subject Totals logic (Class Size) instead of Sum
        let maxStudents = 0;
        if (globalSubjects.length > 0) {
            maxStudents = Math.max(...Object.values(subjectTotals));
        }
        document.getElementById('totalStudents').innerText = toArabicNumerals(maxStudents);
        
        updateSubjectInputAuto();

        if (maxStudents > 0) {
            renderCombinedTable();
            renderChart();
        } else {
            document.querySelector('#combinedTable tbody').innerHTML = '<tr><td colspan="11" style="color:red; padding:20px;">âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ø¶Ø­Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø¹Ù…Ø¯Ø© "Ø§Ù„ØªÙ‚Ø¯ÙŠØ±" Ø£Ùˆ "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹".</td></tr>';
        }
    }
    
    function autoFillInputs(workbook) {
        try {
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet, {header: 1});
            for(let i=0; i<Math.min(json.length, 20); i++) {
                const rowStr = JSON.stringify(json[i]);
                if(rowStr.includes("Ù…Ø¯Ø±Ø³Ø©") && !document.getElementById('inp_school').value) {
                    const cell = json[i].find(c => typeof c === 'string' && c.includes("Ù…Ø¯Ø±Ø³Ø©"));
                    if(cell) document.getElementById('inp_school').value = cell.trim();
                }
            }
        } catch(e) {}
    }

    function updateSubjectInputAuto() {
        const currentVal = document.getElementById('inp_subject').value;
        const isDefault = currentVal === "" || currentVal === "ØªÙ‚Ø±ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯";
        
        if (isDefault) {
             if (globalSubjects.length === 1) {
                document.getElementById('inp_subject').value = globalSubjects[0];
            } else if (globalSubjects.length > 1) {
                document.getElementById('inp_subject').value = "ØªÙ‚Ø±ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯";
            }
        }
        updateReportDisplay();
    }

    // --- Main Logic (Refined) ---
    function processWorkbook(workbook) {
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(firstSheet, {header: 1});

        let fileType = "unknown";
        let scoreColIndex = -1;

        // 1. Text Grades
        for(let r=0; r<Math.min(json.length, 60); r++) {
            if(!json[r]) continue;
            if(json[r].some(cell => gradesOrder.includes((cell+"").trim()))) {
                fileType = "text";
                break;
            }
        }

        // 2. Numeric Scores
        if(fileType === "unknown") {
            const scoreKeywords = ["Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹", "Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ©", "Ø±ØµØ¯ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª" ,"Total", "Score"];
            for(let r=0; r<Math.min(json.length, 50); r++) {
                if(!json[r]) continue;
                json[r].forEach((cell, idx) => {
                    if(scoreKeywords.some(k => (cell+"").includes(k))) {
                        fileType = "numeric";
                        scoreColIndex = idx;
                    }
                });
                if(fileType === "numeric") break;
            }
            // Fallback
             if(fileType === "unknown") {
                 let bestCol = -1;
                 let maxValidNums = 0;
                 for(let c=0; c<30; c++) {
                     let validNums = 0;
                     for(let r=5; r<Math.min(json.length, 100); r++) {
                         if(json[r] && !isNaN(parseFloat(json[r][c]))) {
                             let val = parseFloat(json[r][c]);
                             if(val >= 0 && val <= 100) validNums++; 
                         }
                     }
                     if(validNums > maxValidNums) { maxValidNums = validNums; bestCol = c; }
                 }
                 if(maxValidNums > 5) {
                     fileType = "numeric";
                     scoreColIndex = bestCol;
                 }
             }
        }

        if(fileType === "text") processTextGrades(workbook);
        else if(fileType === "numeric" && scoreColIndex !== -1) processNumericScores(workbook, scoreColIndex);
    }

    // Fix 1 (Crash): This now returns the FINAL key used.
    // If it detects garbage, it normalizes it to a safer key and returns that.
    function initSubject(subject) {
        subject = subject.trim();
        // Rename if garbage
        if (IGNORED_SUBJECTS.some(ignored => subject.includes(ignored))) {
             subject = "Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©";
        }
        if (!subject || subject.length < 2) subject = "Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©";

        if (!globalSubjects.includes(subject)) {
            globalSubjects.push(subject);
            globalCounts[subject] = { "Ø¶Ø¹ÙŠÙ": 0, "Ù…Ù‚Ø¨ÙˆÙ„": 0, "Ø¬ÙŠØ¯": 0, "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹": 0, "Ù…Ù…ØªØ§Ø²": 0 };
            subjectTotals[subject] = 0;
        }
        return subject; // Fix: RETURN the key
    }

    function processTextGrades(workbook) {
        const gradeCol = 23; 
        
        workbook.SheetNames.forEach(sheetName => {
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {header: 1});
            
            let subject = sheetName; 
            for(let r=0; r<15; r++) {
                if(json[r]) {
                    let combined = json[r].join(" ");
                    if(combined.includes("Ø§Ù„Ù…Ø§Ø¯Ø©")) {
                        let potential = combined.split("Ø§Ù„Ù…Ø§Ø¯Ø©")[1].trim().split(" ")[0];
                        if(potential && !IGNORED_SUBJECTS.includes(potential)) subject = potential;
                    }
                }
            }

            json.forEach(row => {
                const grade = (row[gradeCol] || "").toString().trim();
                if(gradesOrder.includes(grade)) {
                    let rowSubject = row[46] || row[17] || subject;
                    rowSubject = rowSubject.toString().trim();
                    
                    // Call initSubject and capture the SAFE key
                    const safeKey = initSubject(rowSubject); // Fix 1
                    
                    globalCounts[safeKey][grade]++;
                    subjectTotals[safeKey]++;
                }
            });
        });
    }

    function processNumericScores(workbook, scoreCol) {
        let maxScore = parseFloat(valueOf('inp_max_score')) || 100;
        let subject = workbook.SheetNames[0]; 

        workbook.SheetNames.forEach(sheetName => {
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {header: 1});
            json.forEach(row => {
               let val = parseFloat(row[scoreCol]);
               if(!isNaN(val) && val >= 0 && val <= maxScore * 1.5) { 
                   // Call initSubject and capture the SAFE key
                   const safeKey = initSubject(subject); // Fix 1 Crash was here (using old 'subject' but init created a new key)
                   
                   let g = getGrade(val, maxScore);
                   globalCounts[safeKey][g]++;
                   subjectTotals[safeKey]++;
               }
            });
        });
    }

    function getGrade(score, max) {
        let pct = (score / max) * 100;
        if(pct >= 90) return "Ù…Ù…ØªØ§Ø²";
        if(pct >= 80) return "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹";
        if(pct >= 65) return "Ø¬ÙŠØ¯";
        if(pct >= 50) return "Ù…Ù‚Ø¨ÙˆÙ„";
        return "Ø¶Ø¹ÙŠÙ";
    }

    // === Rendering ===
    function renderCombinedTable() {
        const tbody = document.querySelector('#combinedTable tbody');
        tbody.innerHTML = "";
        
        // Single Subject Override Logic
        const manualSubject = valueOf('inp_subject');
        
        globalSubjects.forEach(subject => {
            const totalForSub = subjectTotals[subject] || 1; 
            
            // Fix V20.6: Display Override
            let displayName = subject;
            if(globalSubjects.length === 1 && manualSubject && manualSubject.trim().length > 0) {
                displayName = manualSubject;
            }

            let tr = `<tr>`;
            tr += `<td style="font-weight:bold; text-align:right; color:var(--primary-color);">${displayName}</td>`;
            
            gradesOrder.forEach((g, i) => {
                const count = globalCounts[subject][g] || 0;
                const style = i === 4 ? 'border-left: 2px solid #cbd5e1;' : '';
                tr += `<td class="grade-cell" style="${style}">${toArabicNumerals(count)}</td>`;
            });
            
            gradesOrder.forEach(g => {
                const count = globalCounts[subject][g] || 0;
                const pct = ((count / totalForSub) * 100).toFixed(1);
                tr += `<td class="percent-cell">${toArabicNumerals(pct)}%</td>`;
            });
            
            tr += `</tr>`;
            tbody.innerHTML += tr;
        });
    }

    function renderChart() {
        const ctx = document.getElementById('gradesChart').getContext('2d');
        if (window.myChart) window.myChart.destroy();
        Chart.defaults.font.family = "'Cairo', sans-serif";

        if(globalSubjects.length === 1) {
            document.getElementById('chartWrapper').style.maxWidth = "500px";
            document.getElementById('chartWrapper').style.margin = "0 auto";
            document.getElementById('singleSubjectNote').style.display = 'block';
            
            // Fix V20.6: Chart Title Override
            const manualSubject = valueOf('inp_subject');
            let subj = globalSubjects[0];
            let displayTitle = subj;
             if(manualSubject && manualSubject.trim().length > 0) {
                displayTitle = manualSubject;
            }

            window.myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: gradesOrder,
                    datasets: [{
                        data: gradesOrder.map(g => globalCounts[subj][g]),
                        backgroundColor: gradesOrder.map(g => gradeColors[g]),
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { font: { size: 12 } } },
                        title: { display: true, text: 'ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±Ø§Øª: ' + displayTitle, font: { size: 16 } }
                    }
                }
            });
        } else {
            document.getElementById('chartWrapper').style.maxWidth = "100%";
            document.getElementById('singleSubjectNote').style.display = 'none';
            
            // Fix V20.8: Use slice() to avoid mutating global gradesOrder
            const datasets = gradesOrder.slice().reverse().map(g => ({
                label: g,
                data: globalSubjects.map(s => globalCounts[s][g]),
                backgroundColor: gradeColors[g],
                borderRadius: 4
            }));

            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: globalSubjects, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { display: false } },
                        y: { beginAtZero: true, position: 'right' }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§Ø±Ù† Ù„Ù„Ù…ÙˆØ§Ø¯', font: { size: 16 } }
                    }
                }
            });
        }
    }

    function exportToExcel() {
        if(globalSubjects.length === 0) { alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª"); return; }
        
        const data = [];
        globalSubjects.forEach(sub => {
            const total = subjectTotals[sub] || 1;
            // Respect override here too if needed, but usually Excel export keeps internal keys.
            // For now keeping internal key for consistency across rows, but can display override if user insists.
            // Let's stick to internal keys for Export to avoid confusion in multi-mode, or use logic:
             let displayName = sub;
             if(globalSubjects.length === 1) {
                  const manualSubject = valueOf('inp_subject');
                  if(manualSubject) displayName = manualSubject;
             }

            const row = { "Ø§Ù„Ù…Ø§Ø¯Ø©": displayName };
            // Add Counts
            gradesOrder.forEach(g => { row[`Ø¹Ø¯Ø¯ (${g})`] = globalCounts[sub][g]; });
            // Add Pcts
            gradesOrder.forEach(g => { 
                row[`Ù†Ø³Ø¨Ø© (${g})`] = ((globalCounts[sub][g]/total)*100).toFixed(1) + "%"; 
            });
            data.push(row);
        });

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„");
        XLSX.writeFile(wb, "University_Analysis_V20.xlsx");
    }

    function downloadChartImage() {
        const link = document.createElement('a');
        link.download = 'Analysis_Chart_V20.png';
        link.href = document.getElementById('gradesChart').toDataURL();
        link.click();
    }
</script>

</body>
</html>